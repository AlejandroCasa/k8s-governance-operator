# config/default/kustomization.yaml
namespace: k8s-governance-operator-system
namePrefix: k8s-governance-operator-

resources:
- ../crd
- ../rbac
- ../manager
- ../webhook
- ../certmanager
- metrics_service.yaml

patches:
# [METRICS] Enable HTTPS metrics
- path: manager_metrics_patch.yaml
  target:
    kind: Deployment

# [WEBHOOK] Patch the Deployment to use the webhook
- path: manager_webhook_patch.yaml
  target:
    kind: Deployment

# [WEBHOOK EXCLUSION] Prevent Deadlocks (Operator blocking itself)
- path: webhook_exclusion_patch.yaml
  target:
    kind: ValidatingWebhookConfiguration
    group: admissionregistration.k8s.io
- path: mutating_webhook_exclusion_patch.yaml
  target:
    kind: MutatingWebhookConfiguration
    group: admissionregistration.k8s.io

# [CERTMANAGER] Inject CA Bundle into Webhooks (Applies to both)
- path: webhookcainjection_patch.yaml

replacements:
  # ----------------------------------------------------------------
  # 1. FIX CERTIFICATE DNS NAMES (Replaces SERVICE_NAME placeholders)
  # ----------------------------------------------------------------
  - source:
      kind: Service
      version: v1
      name: webhook-service
      fieldPath: .metadata.name
    targets:
      - select:
          kind: Certificate
          group: cert-manager.io
          version: v1
          name: serving-cert
        fieldPaths:
          - .spec.dnsNames.0
          - .spec.dnsNames.1
        options:
          delimiter: '.'
          index: 0
          create: true
  - source:
      kind: Service
      version: v1
      name: webhook-service
      fieldPath: .metadata.namespace
    targets:
      - select:
          kind: Certificate
          group: cert-manager.io
          version: v1
          name: serving-cert
        fieldPaths:
          - .spec.dnsNames.0
          - .spec.dnsNames.1
        options:
          delimiter: '.'
          index: 1
          create: true

  # ----------------------------------------------------------------
  # 2. INJECT CA INTO VALIDATING WEBHOOK
  # ----------------------------------------------------------------
  - source:
      kind: Certificate
      group: cert-manager.io
      version: v1
      name: serving-cert
      fieldPath: .metadata.namespace
    targets:
      - select:
          kind: ValidatingWebhookConfiguration
        fieldPaths:
          - .metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: '/'
          index: 0
          create: true
  - source:
      kind: Certificate
      group: cert-manager.io
      version: v1
      name: serving-cert
      fieldPath: .metadata.name
    targets:
      - select:
          kind: ValidatingWebhookConfiguration
        fieldPaths:
          - .metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: '/'
          index: 1
          create: true

  # ----------------------------------------------------------------
  # 3. INJECT CA INTO MUTATING WEBHOOK
  # ----------------------------------------------------------------
  - source:
      kind: Certificate
      group: cert-manager.io
      version: v1
      name: serving-cert
      fieldPath: .metadata.namespace
    targets:
      - select:
          kind: MutatingWebhookConfiguration
        fieldPaths:
          - .metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: '/'
          index: 0
          create: true
  - source:
      kind: Certificate
      group: cert-manager.io
      version: v1
      name: serving-cert
      fieldPath: .metadata.name
    targets:
      - select:
          kind: MutatingWebhookConfiguration
        fieldPaths:
          - .metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: '/'
          index: 1
          create: true